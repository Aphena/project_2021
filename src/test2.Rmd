#Analysis of kallisto results

```{r setup, include=FALSE}
library("ggplot2")
library("GGally")
library("reshape2")
library("gplots")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE)
```

##Set labels 
````{R lables} 
labels = c() #create empty vectors to which labels will be added
for (i in 9:24){
  new_label = paste("EW", i, sep = "") #create strings (e.g. "EW9")
  labels = c(labels, new_label) #adding strings to vectors
}
print(labels)#print labels
````

##Load all tsv files and reset the names of each file
````{R}
kallisto_tsv_list <- list.files(path = "~/Desktop/2021-RNAproject/results/kallisto_tsv") #read files named EW9.abundance.tsv, EW10.abundance.tsv.. in the folder "kallisto_tsv"
for(i in 1:length(labels)){
  kallisto_filepath <- file.path("~/Desktop/2021-RNAproject/results/kallisto_tsv/", paste(labels[i], ".abundance.tsv", sep = "")) #create file path of all tsv files
  oname = paste(labels[i], "_kallisto", sep = "") #create new names of tsv files as EW9_kallisto, EW10_kallisto,....
  assign(oname, read.csv(kallisto_filepath, sep = "", header = T)) #load all tsv files in the separate dataframe with new names
}
````

##Change the names of column and make sure each colname is different from each other
````{R}
colnames(EW9_kallisto) <- c("EW9_target_id_name", "EW9_length", "EW9_eff_length", "EW9_counts", "EW9_tpm")
colnames(EW10_kallisto) <- c("EW10_target_id_name", "EW10_length", "EW10_eff_length", "EW10_counts", "EW10_tpm")
colnames(EW11_kallisto) <- c("EW11_target_id_name", "EW11_length", "EW11_eff_length", "EW11_counts", "EW11_tpm")
colnames(EW12_kallisto) <- c("EW12_target_id_name", "EW12_length", "EW12_eff_length", "EW12_counts", "EW12_tpm")
colnames(EW13_kallisto) <- c("EW13_target_id_name", "EW13_length", "EW13_eff_length", "EW13_counts", "EW13_tpm")
colnames(EW14_kallisto) <- c("EW14_target_id_name", "EW14_length", "EW14_eff_length", "EW14_counts", "EW14_tpm")
colnames(EW15_kallisto) <- c("EW15_target_id_name", "EW15_length", "EW15_eff_length", "EW15_counts", "EW15_tpm")
colnames(EW16_kallisto) <- c("EW16_target_id_name", "EW16_length", "EW16_eff_length", "EW16_counts", "EW16_tpm")
colnames(EW17_kallisto) <- c("EW17_target_id_name", "EW17_length", "EW17_eff_length", "EW17_counts", "EW17_tpm")
colnames(EW18_kallisto) <- c("EW18_target_id_name", "EW18_length", "EW18_eff_length", "EW18_counts", "EW18_tpm")
colnames(EW19_kallisto) <- c("EW19_target_id_name", "EW19_length", "EW19_eff_length", "EW19_counts", "EW19_tpm")
colnames(EW20_kallisto) <- c("EW20_target_id_name", "EW20_length", "EW20_eff_length", "EW20_counts", "EW20_tpm")
colnames(EW21_kallisto) <- c("EW21_target_id_name", "EW21_length", "EW21_eff_length", "EW21_counts", "EW21_tpm")
colnames(EW22_kallisto) <- c("EW22_target_id_name", "EW22_length", "EW22_eff_length", "EW22_counts", "EW22_tpm")
colnames(EW23_kallisto) <- c("EW23_target_id_name", "EW23_length", "EW23_eff_length", "EW23_counts", "EW23_tpm")
colnames(EW24_kallisto) <- c("EW24_target_id_name", "EW24_length", "EW24_eff_length", "EW24_counts", "EW24_tpm")
````

##Combine SC data.frames and OP data.frames separatly
````{R}
kallisto_SC_df <- cbind(EW9_kallisto, EW10_kallisto, EW11_kallisto, EW12_kallisto, EW13_kallisto, EW14_kallisto, EW15_kallisto, EW16_kallisto) #combine all SC data.frames
kallisto_OP_df <- cbind(EW17_kallisto, EW18_kallisto, EW19_kallisto, EW20_kallisto, EW21_kallisto, EW22_kallisto, EW23_kallisto, EW24_kallisto) #combine all OP data.frames

kallisto_SC_tpm_df <- kallisto_SC_df[, grepl("tpm", names(kallisto_SC_df))] #only extract columns with "tpm" in all SC samples
kallisto_SC_counts_df <- kallisto_SC_df[, grepl("counts", names(kallisto_SC_df))] #only extract columns with "counts" in all SC samples

kallisto_OP_tpm_df <- kallisto_OP_df[, grepl("tpm", names(kallisto_OP_df))] #only extract columns with "tpm" in all OP samples
kallisto_OP_counts_df <- kallisto_OP_df[, grepl("counts", names(kallisto_SC_df))] #only extract columns with "counts" in all OP samples
````

##Scattor plot to explore correlation between samples within same species
````{R}
ggplot(data = data.frame(x = EW9_kallisto$EW9_tpm, y = EW10_kallisto$EW10_tpm), aes(x = x, y = y)) + geom_point() + theme_bw(base_size = 6) + ggtitle("Correlation between SC sample EW9 and EW10") + labs(y="EW10_tpm (heat shock at 42C for 10 mins)", x = "EW9_tpm (control at 30C)") + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10')

ggpairs(data = kallisto_SC_tpm_df, title = "Correlation between SC samples via analyzing tpm values", axisLabels = c("show")) + theme_bw(base_size = 6) + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10') #generate same scatter plot for tpm values in all SC samples

ggpairs(data = kallisto_SC_counts_df, title = "Correlation between SC samples via analyzing counts values") + theme_bw(base_size = 6) + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10') #generate scatter plot for count values in all SC samples

ggpairs(data = kallisto_OP_tpm_df, title = "Correlation between OP samples via analyzing tpm values") + theme_bw(base_size = 6) + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10') #generate scatter plot for tpm values in all OP samples

ggpairs(data = kallisto_OP_counts_df, title = "Correlation between OP samples via analyzing counts values") + theme_bw(base_size = 6) + scale_x_continuous(trans = 'log10') + scale_y_continuous(trans = 'log10') #generate scatter plot for counts values in all OP samples

````

##Heatmap to explore correlation between samples within same species
````{R}
cormat_SC_tpm <- round(cor(kallisto_SC_tpm_df), 2) #create the correlation matrix for tpm values in SC files
melted_cormat_SC_tpm <- melt(cormat_SC_tpm) #melt the correlation matrix
ggplot(data = melted_cormat_SC_tpm, aes(x = Var1, y = Var2, fill = value)) + geom_tile(color = "white") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + scale_fill_gradient2(low = "yellow", high = "red", mid = "orange", midpoint = 0.99, limit = c(0.98,1), space = "Lab") #generate heatmap with ggplot2

cormat_SC_counts <- round(cor(kallisto_SC_counts_df), 2) #create the correlation matrix for count values in SC files
melted_cormat_SC_counts <- melt(cormat_SC_counts) #melt the correlation matrix
ggplot(data = melted_cormat_SC_counts, aes(x = Var1, y = Var2, fill = value)) + geom_tile(color = "white") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + scale_fill_gradient2(low = "yellow", high = "red", mid = "orange", midpoint = 0.99, limit = c(0.98,1), space = "Lab") #generate heatmap with ggplot2

cormat_OP_tpm <- round(cor(kallisto_OP_tpm_df), 2) #create the correlation matrix for tpm values in OP files
melted_cormat_OP_tpm <- melt(cormat_OP_tpm) #melt the correlation matrix
ggplot(data = melted_cormat_OP_tpm, aes(x = Var1, y = Var2, fill = value)) + geom_tile(color = "white") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + scale_fill_gradient2(low = "yellow", high = "red", mid = "orange", midpoint = 0.99, limit = c(0.98,1), space = "Lab") #generate heatmap with ggplot2

cormat_OP_counts <- round(cor(kallisto_OP_counts_df), 2) #create the correlation matrix for count values in OP files
melted_cormat_OP_counts <- melt(cormat_OP_counts) #melt the correlation matrix
ggplot(data = melted_cormat_OP_counts, aes(x = Var1, y = Var2, fill = value)) + geom_tile(color = "white") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + scale_fill_gradient2(low = "yellow", high = "red", mid = "orange", midpoint = 0.99, limit = c(0.98,1), space = "Lab") #generate heatmap with ggplot2
````

##Hierarchical clustering visulized by Heatmap to explore correlation between samples within same species
````{R}
heatmap.2(cormat_SC_tpm, scale = "none", trace = "none", density.info = "none", cexRow = 0.8, cexCol = 0.8, dendrogram = "column", main = "Correlation between SC samples(tpm)", sepcolor = "white", sepwidth=c(0.001,0.001), colsep=1:ncol(cormat_SC_tpm), rowsep=1:nrow(cormat_SC_tpm)) #generate heatmap for all SC samples by using correlation matrix "cormat_SC_tpm"

heatmap.2(cormat_SC_counts, scale = "none", trace = "none", density.info = "none", cexRow = 0.8, cexCol = 0.8, dendrogram = "column", main = "Correlation between SC samples(counts)", sepcolor = "white", sepwidth=c(0.001,0.001), colsep=1:ncol(cormat_SC_counts), rowsep=1:nrow(cormat_SC_counts)) #generate heatmap for all SC samples by using correlation matrix "cormat_SC_counts"

heatmap.2(cormat_OP_tpm, scale = "none", trace = "none", density.info = "none", cexRow = 0.8, cexCol = 0.8, dendrogram = "column", main = "Correlation between OP samples(tpm)", sepcolor = "white", sepwidth=c(0.001,0.001), colsep=1:ncol(cormat_OP_tpm), rowsep=1:nrow(cormat_OP_tpm)) #generate heatmap for all OP samples by using correlation matrix "cormat_OP_tpm"

heatmap.2(cormat_OP_counts, scale = "none", trace = "none", density.info = "none", cexRow = 0.75, cexCol = 0.75, dendrogram = "column", main = "Correlation between OP samples(counts)", sepcolor = "white", sepwidth=c(0.001,0.001), colsep=1:ncol(cormat_OP_counts), rowsep=1:nrow(cormat_OP_counts)) #generate heatmap for all OP samples by using correlation matrix "cormat_OP_counts"
````


